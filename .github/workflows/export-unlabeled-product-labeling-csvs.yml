name: Export unlabeled product labeling CSVs

on:
  workflow_dispatch:

jobs:
  export-unlabeled:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.RW_DATABASE_URL }}
      MAX_PER_FILE: 900

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Export products with missing food_group
        run: |
          set -euo pipefail

          mkdir -p exports/unlabeled

          echo "Checking how many products are missing food_group..."
          TOTAL=$(psql "$DATABASE_URL" -t -A -c \
            "SELECT COUNT(*) FROM products WHERE food_group IS NULL OR food_group = ''")
          echo "Total rows with missing food_group: $TOTAL"

          if [ "$TOTAL" -eq 0 ]; then
            echo "Nothing to export."
            exit 0
          fi

          MAX_PER_FILE=${MAX_PER_FILE}
          MAX_BATCH=$(( (TOTAL + MAX_PER_FILE - 1) / MAX_PER_FILE ))
          echo "Will create $MAX_BATCH CSV files (max $MAX_PER_FILE rows each)."

          for B in $(seq 1 "$MAX_BATCH"); do
            OFFSET=$(( (B - 1) * MAX_PER_FILE ))
            OUTFILE="exports/unlabeled/products_missing_foodgroup_unlabeled_part$((B-1)).csv"

            echo "Writing $OUTFILE (offset $OFFSET)..."

            psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "\copy (
              SELECT
                p.id AS product_id,
                p.name,
                p.brand,
                p.size_text,
                (
                  SELECT string_agg(DISTINCT s.chain, ', ' ORDER BY s.chain)
                  FROM prices pr
                  JOIN stores s ON s.id = pr.store_id
                  WHERE pr.product_id = p.id
                ) AS stores_sample,
                COALESCE(p.food_group, '') AS current_food_group,
                p.sub_code AS current_sub_code,
                ''::text AS food_group_corrected,
                ''::text AS new_sub_code
              FROM products p
              WHERE p.food_group IS NULL OR p.food_group = ''
              ORDER BY p.id
              LIMIT $MAX_PER_FILE OFFSET $OFFSET
            ) TO STDOUT WITH CSV HEADER" > "$OUTFILE"
          done

      - name: Upload CSVs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: products-missing-foodgroup-unlabeled
          path: exports/unlabeled/*.csv
