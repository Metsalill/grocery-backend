name: "Export products for matching (Barbora / Rimi / Selver / Prisma)"

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Prepare DATABASE_URL (public) with sslmode=require
        id: prep
        env:
          DBURL_PUBLIC: ${{ secrets.DATABASE_URL_PUBLIC }}
          DBURL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail
          URL="${DBURL_PUBLIC:-$DBURL}"
          if [ -z "${URL}" ]; then
            echo "No DATABASE_URL_PUBLIC or DATABASE_URL secret set." >&2
            exit 1
          fi
          if [[ "$URL" == *"?"* ]]; then
            case "$URL" in
              *"sslmode="*) : ;;
              *) URL="${URL}&sslmode=require" ;;
            esac
          else
            URL="${URL}?sslmode=require"
          fi
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Show table counts (sanity)
        env:
          DATABASE_URL: ${{ steps.prep.outputs.url }}
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
          \pset footer off
          SELECT 'barbora_candidates' AS table_name, COUNT(*) AS rows_total FROM barbora_candidates;
          SELECT 'rimi_candidates'     AS table_name, COUNT(*) AS rows_total FROM rimi_candidates;
          SELECT 'selver_side_norm'    AS table_name, COUNT(*) AS rows_total FROM selver_side_norm;
          -- Adjust the predicate for Prisma if your column name differs
          SELECT 'products (prisma)'   AS table_name, COUNT(*) AS rows_total
          FROM products
          WHERE chain = 'prisma' OR retailer = 'prisma' OR source = 'prisma';
          SQL

      # --- Barbora ---
      - name: Export Barbora → /tmp/barbora_products.csv
        env:
          DATABASE_URL: ${{ steps.prep.outputs.url }}
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "\copy (
            SELECT
              source_url AS barbora_uid,                                  -- stable ID
              name,
              brand,
              ean_raw AS ean,
              size_text,
              price,
              currency
            FROM barbora_candidates
            WHERE brand IS NOT NULL AND btrim(brand) <> ''
            ORDER BY name, brand, size_text
          ) TO '/tmp/barbora_products.csv' WITH CSV HEADER ENCODING 'UTF8'"

      # --- Rimi ---
      - name: Export Rimi → /tmp/rimi_products.csv
        env:
          DATABASE_URL: ${{ steps.prep.outputs.url }}
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "\copy (
            SELECT
              name,
              brand,
              ean,
              size_text
            FROM rimi_candidates
            ORDER BY name, brand, size_text
          ) TO '/tmp/rimi_products.csv' WITH CSV HEADER ENCODING 'UTF8'"

      # --- Selver ---
      - name: Export Selver → /tmp/selver_products.csv
        env:
          DATABASE_URL: ${{ steps.prep.outputs.url }}
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "\copy (
            SELECT
              name,
              brand,
              ean,
              size_text
            FROM selver_side_norm
            ORDER BY name, brand, size_text
          ) TO '/tmp/selver_products.csv' WITH CSV HEADER ENCODING 'UTF8'"

      # --- Prisma (from products) ---
      - name: Export Prisma → /tmp/prisma_products.csv
        env:
          DATABASE_URL: ${{ steps.prep.outputs.url }}
        run: |
          set -euo pipefail
          # If your products table uses a different column than chain|retailer|source to mark "prisma",
          # replace the WHERE clause accordingly.
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "\copy (
            SELECT
              name,
              brand,
              ean,
              size_text
            FROM products
            WHERE chain = 'prisma' OR retailer = 'prisma' OR source = 'prisma'
            ORDER BY name, brand, size_text
          ) TO '/tmp/prisma_products.csv' WITH CSV HEADER ENCODING 'UTF8'"

      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: product_exports_csv
          path: |
            /tmp/barbora_products.csv
            /tmp/rimi_products.csv
            /tmp/selver_products.csv
            /tmp/prisma_products.csv
          if-no-files-found: error
          compression-level: 0
