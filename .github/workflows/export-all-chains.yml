name: Export all chains (matching dataset)

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chain: [Selver, Prisma, Rimi, Barbora]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Export ${{ matrix.chain }} products CSV
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PUBLIC }} # public host; reachable from GitHub runners
        run: |
          set -euo pipefail
          mkdir -p out

          # Prefer exact chain via stores.chain; fallback to name contains
          FILTER_COND="(s.chain ILIKE '${{ matrix.chain }}%' OR s.name ILIKE '%' || '${{ matrix.chain }}' || '%')"

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -X \
            -c "\copy (
                  SELECT
                    s.chain,
                    s.name               AS store_name,
                    s.id                 AS store_id,
                    p.id                 AS product_id,
                    p.name               AS product,
                    p.brand,
                    p.size_text,
                    p.ean,               -- may be NULL for Rimi/Barbora
                    pr.ext_id,           -- per-store external id
                    pr.price,
                    pr.collected_at
                  FROM prices pr
                  JOIN products p ON p.id = pr.product_id
                  JOIN stores   s ON s.id = pr.store_id
                  WHERE ${FILTER_COND}
                ) TO STDOUT WITH CSV HEADER" \
            > "out/${{ matrix.chain }}_products.csv"

      - name: Upload ${{ matrix.chain }} CSV
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.chain }}-products
          path: out/${{ matrix.chain }}_products.csv
