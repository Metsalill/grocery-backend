name: Coop Bolt scrape + DB ingest

on:
  workflow_dispatch:
  schedule:
    - cron: "12 3 * * *"   # run nightly; tweak as you wish

jobs:
  scrape-bolt:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - city: tartu
            store: kvartali-coop-maksimarket
            categories_file: data/bolt/2-tartu/kvartali-coop-maksimarket.txt
            out: out/bolt_kvartali.csv

          - city: tartu
            store: lounakeskuse-coop-maksimarket
            categories_file: data/bolt/2-tartu/lounakeskuse-coop-maksimarket.txt
            out: out/bolt_lounakeskus.csv

          - city: tartu
            store: eedeni-coop-maksimarket
            categories_file: data/bolt/2-tartu/eedeni-coop-maksimarket.txt
            out: out/bolt_eedeni.csv

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crawler deps
        run: |
          python -m pip install --upgrade pip
          # tolerate missing requirements.txt
          pip install -r requirements.txt || true
          pip install playwright selectolax beautifulsoup4 httpx[socks] tenacity pydantic asyncpg
          python -m playwright install --with-deps chromium

      - name: Run Bolt crawler + ingest
        run: |
          set -euo pipefail
          mkdir -p out
          python3 scripts/bolt_crawler.py \
            --categories-file "${{ matrix.categories_file }}" \
            --city "${{ matrix.city }}" \
            --store "${{ matrix.store }}" \
            --upsert-db main \
            --out "${{ matrix.out }}" \
            --headless 1 \
            --req-delay 1

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bolt-${{ matrix.store }}
          path: ${{ matrix.out }}
