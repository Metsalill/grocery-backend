name: "Export products for matching (with amount)"

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - name: Set up job
        run: echo "Starting product export per online store"

      - name: Run actions/checkout@v4
        uses: actions/checkout@v4

      - name: Install psql
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Export Selver
        shell: bash
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
          SET lock_timeout = '5s';
          SET statement_timeout = '45min';
          SET client_min_messages = WARNING;

          \copy (
            SELECT p.id,
                   p.name,
                   COALESCE(p.brand,'')     AS brand,
                   COALESCE(p.ean,'')       AS ean,
                   COALESCE(p.size_text,'') AS size_text,
                   COALESCE(p.amount,'')    AS amount
            FROM products p
            JOIN prices pr ON pr.product_id = p.id
            JOIN stores s ON s.id = pr.store_id
            WHERE s.name ILIKE '%e-Selver%' OR s.name ILIKE '%Selver e-%'
            GROUP BY p.id, p.name, p.brand, p.ean, p.size_text, p.amount
          ) TO 'selver_products.csv' WITH CSV HEADER;
SQL

      - name: Export Prisma
        shell: bash
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
          SET lock_timeout = '5s';
          SET statement_timeout = '45min';
          SET client_min_messages = WARNING;

          \copy (
            SELECT p.id,
                   p.name,
                   COALESCE(p.brand,'')     AS brand,
                   COALESCE(p.ean,'')       AS ean,
                   COALESCE(p.size_text,'') AS size_text,
                   COALESCE(p.amount,'')    AS amount
            FROM products p
            JOIN prices pr ON pr.product_id = p.id
            JOIN stores s ON s.id = pr.store_id
            WHERE s.name ILIKE '%Prisma Online%'
            GROUP BY p.id, p.name, p.brand, p.ean, p.size_text, p.amount
          ) TO 'prisma_products.csv' WITH CSV HEADER;
SQL

      - name: Export Rimi
        shell: bash
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
          SET lock_timeout = '5s';
          SET statement_timeout = '45min';
          SET client_min_messages = WARNING;

          \copy (
            SELECT p.id,
                   p.name,
                   COALESCE(p.brand,'')     AS brand,
                   COALESCE(p.ean,'')       AS ean,
                   COALESCE(p.size_text,'') AS size_text,
                   COALESCE(p.amount,'')    AS amount
            FROM products p
            JOIN prices pr ON pr.product_id = p.id
            JOIN stores s ON s.id = pr.store_id
            WHERE s.name ILIKE '%Rimi ePood%'
            GROUP BY p.id, p.name, p.brand, p.ean, p.size_text, p.amount
          ) TO 'rimi_products.csv' WITH CSV HEADER;
SQL

      - name: Export Barbora
        shell: bash
        run: |
          set -euo pipefail
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
          SET lock_timeout = '5s';
          SET statement_timeout = '45min';
          SET client_min_messages = WARNING;

          \copy (
            SELECT p.id,
                   p.name,
                   COALESCE(p.brand,'')     AS brand,
                   COALESCE(p.ean,'')       AS ean,
                   COALESCE(p.size_text,'') AS size_text,
                   COALESCE(p.amount,'')    AS amount
            FROM products p
            JOIN prices pr ON pr.product_id = p.id
            JOIN stores s ON s.id = pr.store_id
            WHERE s.name ILIKE '%Barbora%' OR s.name ILIKE '%Maxima%'
            GROUP BY p.id, p.name, p.brand, p.ean, p.size_text, p.amount
          ) TO 'barbora_products.csv' WITH CSV HEADER;
SQL

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: exported-products
          path: |
            selver_products.csv
            prisma_products.csv
            rimi_products.csv
            barbora_products.csv
