name: Coop Wolt Crawl + Ingest

on:
  workflow_dispatch: {}
  schedule:
    # every 4 hours (UTC); adjust if you want slower/faster
    - cron: "0 */4 * * *"

jobs:
  crawl-wolt:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        include:
          # IMPORTANT:
          # - store_host must match the slug after /venue/ in wolt.com URL
          #   e.g. https://wolt.com/.../venue/coop-lasnamae -> "wolt:coop-lasnamae"
          # - store_id must match stores.id in Postgres
          # - city is just a geo hint ("tallinn" or "parnu")
          #
          - store_host: "wolt:coop-parnu"
            city: "parnu"
            store_id: "551"   # Wolt: Coop Põrnu (in DB)
          - store_host: "wolt:coop-laagri"
            city: "tallinn"
            store_id: "552"   # Wolt: Coop Laagri
          - store_host: "wolt:konsum-juri"
            city: "tallinn"
            store_id: "553"   # Wolt: Konsum Jüri
          - store_host: "wolt:coop-miiduranna"
            city: "tallinn"
            store_id: "554"   # Wolt: Coop Miiduranna
          - store_host: "wolt:coop-akadeemia"
            city: "tallinn"
            store_id: "555"   # Wolt: Coop Akadeemia
          - store_host: "wolt:coop-lasnamae"
            city: "tallinn"
            store_id: "556"   # Wolt: Coop Lasnamõe
          - store_host: "wolt:coop-mustakivi"
            city: "tallinn"
            store_id: "557"   # Wolt: Coop Mustakivi
          - store_host: "wolt:konsum-saku"
            city: "tallinn"
            store_id: "558"   # Wolt: Konsum Saku

    env:
      TZ: Europe/Tallinn
      DATABASE_URL: ${{ secrets.DATABASE_URL_PUBLIC }}   # same style you already use
      STORE_ID: ${{ matrix.store_id }}
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Crawl & ingest this Wolt store
        run: |
          python3 wolt_crawler.py \
            --store-host "${{ matrix.store_host }}" \
            --city "${{ matrix.city }}" \
            --upsert-db 1 \
            --ingest-mode main
